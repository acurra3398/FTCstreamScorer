{"version":3,"file":"backup-CmJQ5Yhu.js","sources":["../../../../../../src/main/javascript/manage/backup/BackupConfig.tsx","../../../../../../src/main/javascript/manage/backup/index.tsx"],"sourcesContent":["import {t} from \"ftc-common/i18n\";\nimport {promptDialog, messageDialog} from \"first-common/dialogs\";\nimport {useState} from \"react\";\nimport {BackupDestination, SystemEvent} from \"../../javaTypes\";\n\nfunction BackupDestinationDetails({destination, remove}: { destination: BackupDestination, remove: (uri: string) => void }) {\n    const url = new URL(destination.uri);\n    let text: JSX.Element | string = destination.uri;\n    if(url.protocol == 'file:') {\n        text = t`Directory: ${url.pathname}`\n    } else if(url.protocol.startsWith(\"http\")) {\n        url.username = '';\n        url.password = '';\n        text = <>{t`Remote server: `}<a href={url.href} target=\"_blank\" rel=\"noreferrer\">{url.host}</a></>\n    }\n    const lastAttempt = destination.lastAttempt ? new Date(destination.lastAttempt).toLocaleString() : 'unknown';\n    return <li>{text} {destination.lastError ? <>\n        <i className=\"fa fa-exclamation-triangle\"></i>{t`(backup failed at ${lastAttempt})`}\n    </> : t`(last backed up at ${lastAttempt})`}<button className={\"btn btn-sm btn-danger\"} onClick={() => remove(destination.uri)}><i className={\"fas fa-trash\"}></i></button>\n        {destination.lastError ? <details><pre style={{whiteSpace: 'pre-wrap'}}>{destination.lastError}</pre></details> : null}\n    </li>\n}\n\nfunction ImportStatus({data}: { data: SystemEvent }) {\n    return <li>{data.event}: ({new Date(data.timestamp).toLocaleString()}) </li>;\n}\n\nexport function BackupConfig({isReplica: origIsReplica, replicaPassword: origReplicaPassword, backupDestinations: origBackupDestinations, importStatuses}: {\n    isReplica: boolean,\n    replicaPassword: string,\n    backupDestinations: BackupDestination[],\n    importStatuses?: SystemEvent[]\n}) {\n    const [isReplica, setIsReplica] = useState(origIsReplica);\n    const [replicaPassword, setReplicaPassword] = useState(origReplicaPassword);\n    const [backupDestinations, setBackupDestinations] = useState(origBackupDestinations);\n    async function setReplica(isReplica: boolean) {\n        const params = new URLSearchParams();\n        params.append(\"isReplica\", isReplica ? 'true' : 'false');\n        const res = await fetch(\"/manage/togglereplica/\", {\n            method: 'POST',\n            body: params\n        })\n        const response = await res.json();\n        setIsReplica(isReplica);\n        if (isReplica) {\n            setReplicaPassword(response.replicaPassword);\n        }\n    }\n\n    async function addRemoteServer() {\n        const server = await promptDialog({\n            label: t`Add remote server`,\n            text: t`Remote address`,\n            buttonText: t`Add`\n        })\n        if(!server) {\n            return;\n        }\n        const password = await promptDialog({\n            label: t`Add remote server`,\n            text: t`Backup server password`,\n            buttonText: t`Add`\n        })\n        if(!password) {\n            return;\n        }\n        await addBackupDestination(`http://ems:${password}@${server}`)\n    }\n\n    async function addDirectory() {\n        const dir = await promptDialog({\n            label: t`Add directory`,\n            text: t`Path to store backups (e.g. D:/ftc-backup or /Volumes/MyDrive/ftc-backup)`,\n            buttonText: t`Add`\n        })\n        if(!dir) {\n            return;\n        }\n        let prefix = '';\n        if(dir.match(/^[a-z]:/i)) {\n            prefix = '/';\n        }\n        await addBackupDestination(`file://${prefix}${dir}`)\n    }\n\n    async function addBackupDestination(uri: string) {\n        const params = new URLSearchParams();\n        params.append(\"uri\", uri);\n        const res = await fetch(\"/manage/backup/\", {\n            method: 'PUT',\n            body: params\n        })\n        const text = await res.text();\n        if(text != 'OK') {\n            messageDialog({label: t`Add failed`, text: t`Failed to add backup destination`})\n        } else {\n            setBackupDestinations((was) => [...was, {\n                uri,\n                lastAttempt: Date.now(),\n            } as BackupDestination])\n        }\n    }\n\n    async function removeBackupDestination(uri: string) {\n        const params = new URLSearchParams();\n        params.append(\"uri\", uri);\n        const res = await fetch(`/manage/backup/`, {\n            method: 'DELETE',\n            body: params\n        })\n        const text = await res.text();\n        if(text != 'OK') {\n            messageDialog({label: t`Add failed`, text: t`Failed to remove backup destination`})\n        } else {\n            setBackupDestinations((was) => was.filter(bd => bd.uri !== uri))\n        }\n    }\n\n    return <fieldset>\n        <legend>{t`Backup Configuration`}</legend>\n        {isReplica ? <>\n            <p>{t`Backup last loaded`}</p>\n            <ul>\n                {importStatuses?.sort((a, b) => a.event.localeCompare(b.event)).map((is) => <ImportStatus key={is.event} data={is} />)}\n            </ul>\n        </> : <>\n            <p>{t`Backup destinations`}</p>\n            <ul>\n                {backupDestinations.map((bd) => <BackupDestinationDetails key={bd.uri} destination={bd} remove={removeBackupDestination} />)}\n            </ul>\n\n            <button className={\"btn btn-small btn-secondary\"} onClick={addRemoteServer}>{t`Add remote server`}</button>\n            <button className={\"btn btn-small btn-secondary ml-2\"} onClick={addDirectory}>{t`Add directory`}</button>\n        </>}\n\n        <p>{isReplica ?\n            t`Currently acting as replica. Replication password: ${replicaPassword}` :\n            t`Currently acting as primary.`\n        }</p>\n        <button className={`btn btn-${isReplica ? 'danger' : 'warning'}`} onClick={() => setReplica(!isReplica)}>{isReplica ? t`Become Primary` : t`Become Replica`}</button>\n        <br/>\n        <small>{isReplica ?\n            t`This should only be done if the current primary server is now offline` :\n            t`Receive updates from a primary server so this server is ready to take over at a moment's notice`}</small>\n    </fieldset>\n}","import {BackupConfig} from \"./BackupConfig\";\nimport {BackupDestination, SystemEvent} from '../../javaTypes';\nimport { createRoot } from \"react-dom/client\";\n\ndeclare global {\n    interface Window {\n        isReplica?: boolean,\n        replicaPassword?: string,\n        backupDestinations: BackupDestination[],\n        importStatuses?: SystemEvent[]\n    }\n}\n\nconst container = document.getElementById('backupConfiguration');\nif(!container) {\n    console.error(\"Mount point for ref container not found\")\n} else {\n    const root = createRoot(container);\n    root.render(<BackupConfig isReplica={window.isReplica || false} replicaPassword={window.replicaPassword || ''} backupDestinations={window.backupDestinations} importStatuses={window.importStatuses}/>);\n}\n"],"names":["BackupDestinationDetails","destination","remove","url","text","jsxs","Fragment","jsx","lastAttempt","ImportStatus","data","BackupConfig","origIsReplica","origReplicaPassword","origBackupDestinations","importStatuses","isReplica","setIsReplica","useState","replicaPassword","setReplicaPassword","backupDestinations","setBackupDestinations","setReplica","params","response","addRemoteServer","server","promptDialog","password","addBackupDestination","addDirectory","dir","prefix","uri","messageDialog","was","removeBackupDestination","bd","b","is","container","createRoot"],"mappings":"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"}