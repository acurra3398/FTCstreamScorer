import{r as y,j as e,t as r,a as g,c as Se}from"../client-BvsFx6Uv.js";import{E as Te}from"../LocalErrorBoundary-B_5iy1c-.js";import{u as je,P as z}from"../utils-CzBzcnQn.js";import{a as X}from"../javaTypes-DNGMEgAs.js";import{m as $,c as Y}from"../dialogs-Cji8mkGY.js";import{l as D}from"../lodash-DEhfaarB.js";import{X as p}from"../classApi-CCs8VasB.js";import{A as E}from"../Alert-DR6HmQEy.js";import{B as C}from"../Button-CplEHJLM.js";import{P as be}from"../ProgressBar-CdbDon19.js";import{O as Ne,T as Pe}from"../Tooltip-CgF0-DCE.js";import{F as S}from"../Form-C93KviTp.js";import"../exports-gx3CWV9A.js";import"../merge-BCxs0UCa.js";import"../Modal-BSxbHkAp.js";import"../index-CsyH6pUe.js";import"../warning-PI8mi4Hb.js";import"../querySelectorAll-CV_V5nX6.js";import"../createWithBsPrefix-Bt6Ige_C.js";import"../hook-ByTrhTT2.js";import"../SafeAnchor-G5C8N4yQ.js";import"../ElementChildren-DccXaKZk.js";import"../usePopperMarginModifiers-OKrDsYDV.js";import"../isRequiredForA11y-D3y9EsJd.js";import"../all-crwlzFAZ.js";try{let i=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new i.Error().stack;a&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[a]="466979d2-6f1e-4c90-8e70-e509b640fb06",i._sentryDebugIdIdentifier="sentry-dbid-466979d2-6f1e-4c90-8e70-e509b640fb06")}catch{}function Z({value:i,onChange:a,min:m,max:d,step:s,...v}){const[t,l]=y.useState(i.toString());y.useEffect(()=>{l(i.toString())},[i]);const u=(s?D.isNumber(s)?s:parseFloat(s)||1:1)<1?parseFloat:parseInt;return e.jsx("input",{type:"number",value:t,min:m,max:d,step:s,...v,onChange:h=>{l(h.currentTarget.value),h.currentTarget!=document.activeElement&&a(u(h.currentTarget.value))},onBlur:h=>{let f=u(h.currentTarget.value);m!=null&&f<(D.isNumber(m)?m:parseFloat(m))&&(f=D.isNumber(m)?m:parseFloat(m)),d!=null&&f>(D.isNumber(d)?d:parseFloat(d))&&(f=D.isNumber(d)?d:parseFloat(d)),isNaN(f)?l(i.toString()):(l(f.toString()),a(f))},style:{width:"5em"}})}const U=[document.documentElement.lang,{hour:"numeric",minute:"numeric"}];function k(i){return Math.max(0,Math.floor(i.start.until(i.end).total({unit:"second"})/i.cycleTime.total({unit:"second"})))}function Ce({date:i,block:a,updateBlock:m,overlaps:d,minCycle:s}){const v=k(a),t=a.start.until(a.end).subtract({seconds:a.cycleTime.total({unit:"second"})*v}).total({unit:"minute"}),l=y.useId(),o=a.cycleTime.total({unit:"minute"});return e.jsxs("div",{className:"border border-dark m-2 p-2",children:[e.jsxs("h4",{className:"form-inline",children:[a.start.toLocaleString(...U)," - ",a.end.toLocaleString(...U),": ",a.readOnly?v:e.jsx(Z,{className:"ml-2 mr-2",value:v,min:0,style:{width:"5em"},onChange:u=>{let h=a.start.add(p.Duration.from({seconds:u*a.cycleTime.total({unit:"second"})}));a.cycleTime.total({unit:"minute"})>=5&&(h=h.round({smallestUnit:"minutes",roundingMode:"expand",roundingIncrement:5})),m({...a,end:h})}})," ",g.ngettext(g.msgid`Match`,g.msgid`Matches`,v)," ",a.readOnly?r` already played`:null,d?e.jsx(Ne,{overlay:e.jsx(Pe,{id:`${l}-overlap`,children:r`This block overlaps with another block.`}),children:e.jsx("i",{className:"fas fa-exclamation-triangle"})}):null]}),e.jsxs("h5",{children:[a.start.until(a.end).total({unit:"minutes"})," minutes ",t>0?g.ngettext(g.msgid`(Last match ends ${t} minute before end of block)`,`(Last match ends ${t} minutes before end of block)`,t):null]}),a.readOnly?e.jsx("div",{children:r`Cycle Time: ${o}`}):e.jsxs(S,{inline:!0,children:[e.jsx(S.Label,{htmlFor:`${l}-start`,className:"mr-2",children:r`Start`}),e.jsx(S.Control,{className:"mr-2",id:`${l}-start`,type:"time",value:a.start.toPlainTime().toString({smallestUnit:"minute"}),onChange:u=>{const h=i.toPlainDateTime(p.PlainTime.from(u.currentTarget.value));m({...a,start:h,end:h.add(a.start.until(a.end))})}}),e.jsx(S.Label,{htmlFor:`${l}-end`,className:"mr-2",children:r`End`}),e.jsx(S.Control,{className:"mr-2",id:`${l}-end`,type:"time",value:a.end.toPlainTime().toString({smallestUnit:"minute"}),onChange:u=>m({...a,end:i.toPlainDateTime(p.PlainTime.from(u.currentTarget.value))})}),e.jsx(S.Label,{htmlFor:`${l}-cycle`,className:"mr-2",children:r`Cycle Time`}),e.jsx(Z,{className:"mr-2",id:`${l}-cycle`,min:s,step:.5,value:o,onChange:u=>m({...a,cycleTime:p.Duration.from({seconds:u*60})})}),e.jsx("div",{className:"flex-grow-1"}),e.jsx(C,{variant:"secondary",size:"sm",onClick:()=>m(void 0),children:r`Remove`})]}),e.jsx("small",{children:a.roundInfo})]})}function Me({block:i,updateBlock:a}){const m=y.useId();return e.jsxs("div",{className:"border border-dark m-2 p-2",children:[e.jsxs("h4",{children:[i.start.toLocaleString(...U)," - ",i.end.toLocaleString(...U),": Break"]}),e.jsxs("h5",{children:[i.start.until(i.end).total({unit:"minutes"})," minutes"]}),e.jsxs(S,{inline:!0,children:[e.jsx(S.Label,{htmlFor:`${m}-label`,className:"mr-2",children:r`Label`}),e.jsx(S.Control,{className:"mr-2",id:`${m}-label`,value:i.label,style:{width:"15em"},onChange:d=>a({...i,label:d.currentTarget.value,visible:i.label.length==0?!0:d.currentTarget.value.length==0?!1:i.visible})}),e.jsx(S.Label,{htmlFor:`${m}-visible`,className:"mr-2",children:r`Show on Printable Schedule`}),e.jsx(S.Check,{custom:!0,className:"mr-2",id:`${m}-visible`,checked:i.visible,onChange:d=>a({...i,visible:d.currentTarget.checked})})]})]})}function Ae(i,a){return function(m,d){const s=m.map(t=>d.replace==t?d.insert:t).filter(t=>!!t);for(!d.replace&&d.insert&&s.push(d.insert),s.sort((t,l)=>{let o=p.PlainDateTime.compare(t.start,l.start);return o!=0?o:t.type=="BREAK"&&l.type=="MATCH"?-1:t.type=="MATCH"&&l.type=="BREAK"?1:0});s.length>0&&s[0].type=="BREAK";)s.shift();for(;s.length>0&&s[s.length-1].type=="BREAK";)s.pop();for(let t=0;t<s.length;t++)if(s[t].start.toPlainDate().toString()!=s[t].end.toPlainDate().toString())if(s[t].type=="MATCH"){const l=s[t].end,o=s[t].start.withPlainTime({hour:23,minute:59});s[t].end=o;const u={start:o.add({minutes:1}),end:l,cycleTime:s[t].cycleTime};p.Duration.compare(u.start.until(u.end),u.cycleTime)>=0&&s.splice(t+1,0)}else s.splice(t,1);for(let t=1;t<s.length-1;t++)if(s[t].type=="BREAK"){const l=s[t-1],o=s[t+1];s[t].start=l.end,s[t].end=o.start}if(d.lastPlayed&&d.lastPlayed>0){let t=0;for(let l=0;l<s.length;l++){const o=s[l];if(o.type=="MATCH"){if(t<d.lastPlayed&&(o.readOnly=!0),t<d.lastPlayed&&d.lastPlayed<t+k(o)){const u=o.start.add({seconds:(d.lastPlayed-t)*o.cycleTime.total({unit:"second"})});s.splice(l+1,0,{type:"MATCH",start:u,end:o.end,cycleTime:o.cycleTime}),o.end=u,l++}t+=k(o)}}}let v=0;for(let t=0;t<s.length;t++){const l=s[t];if(l.type=="MATCH"){v+=k(l);let o=0;v>Math.ceil(i*2/4)&&(o=(4-a*i%4)%4);const u=v*4-o,h=Math.floor(u/i),f=u-i*h,w=i-f;let T;f>0?(T=g.ngettext(g.msgid`After this block, ${f} team will have played ${h+1} matches.`,g.msgid`After this block, ${f} teams will have played ${h+1} matches.`,f),h!=1?T+=" "+g.ngettext(g.msgid`${w} team will have played ${h} matches.`,g.msgid`${w} teams will have played ${h} matches.`,w):T+=" "+g.ngettext(g.msgid`${w} team will have played ${h} match.`,g.msgid`${w} teams will have played ${h} match.`,w)):T=g.ngettext(g.msgid`After this block, all teams will have played ${h} match.`,g.msgid`After this block, all teams will have played ${h} matches.`,h),o>0&&(T+=" "+g.ngettext(g.msgid`(And ${o} team will have played as a surrogate.)`,g.msgid`(And ${o} teams will have played as a surrogate.)`,o)),l.roundInfo=T}N(l)&&t<s.length-1&&N(s[t+1])&&l.start.toPlainDate().toString()==s[t+1].start.toPlainDate().toString()&&s.splice(t+1,0,{type:"BREAK",label:"",start:l.end,end:s[t+1].start,visible:!1})}return s}}function N(i){return i.type=="MATCH"}function $e({eventCode:i,matchCountData:a,initialSchedule:m,allowCustomSchedules:d,startDate:s,endDate:v,phase:t}){var ne;const[l,o]=y.useState(a.perTeam),u=Math.ceil(a.teamCount*l/4),h=y.useCallback(Ae(a.teamCount,l),[a.teamCount,l]),[f,w]=y.useReducer(h,m),T=new Set([s.toString()]);for(let n=s;n.until(v).total({unit:"day"})>=0;n=n.add({days:1}))T.add(n.toString());f.forEach(n=>{T.add(n.start.toPlainDate().toString())});const A=[...T].map(n=>p.PlainDate.from(n));A.sort(p.PlainDate.compare);const[V,F]=y.useState(void 0),[M,B]=y.useState(!1),[j,K]=y.useState(-1),[O,Q]=y.useState(!1),[de,me]=y.useState("0"),ee=y.useRef(null),[te,ue]=y.useState({}),[R,he]=y.useState(null);je((window.location.protocol.indexOf("s")>0?"wss://":"ws://")+window.location.host+`/stream/matchmaker/?code=${i}`,async n=>{var c;ue(n),((c=n[t])==null?void 0:c.status)==="SUCCESS"&&_()});const b=((ne=te[t])==null?void 0:ne.status)==="SUCCESS"?void 0:te[t],W=a.teamCount>11?4:a.teamCount>7?8:9;y.useEffect(()=>{if(f.length==0&&A.length>=1){const n=Math.max(7,W),x=(A.filter(G=>t=="QUALS"?G.dayOfWeek>=6:!0)[0]||A[0]).toPlainDateTime(new p.PlainTime(8,0)),H=x.add(p.Duration.from({minutes:u*n})).round({smallestUnit:"minutes",roundingMode:"expand",roundingIncrement:5});w({insert:{type:"MATCH",cycleTime:p.Duration.from({minutes:n}),start:x,end:H}})}},[a]);async function _(){const n=await fetch(`/event/${i}/dashboard/schedule/${t}/data/`);if(n.ok){const c=await n.json();F(c.schedule),Q(!0),B(c.scheduleActive),K(c.lastPlayed)}}y.useEffect(()=>{w({lastPlayed:j})},[j]),y.useEffect(()=>{_()},[]);const I=f.reduce((n,c)=>{const x=c.start.toPlainDate().toString();return n[x]=n[x]||[],n[x].push(c),n},{}),L=f.filter(N).reduce((n,c)=>n+k(c),0);async function fe(){const n=await fetch("./preview/",{method:"POST",body:z({mpt:l,schedule:JSON.stringify(f.map(c=>({...c,start:c.start.toString(),end:c.end.toString()})))})});n.ok&&F(await n.text())}async function pe(){const n=await fetch(".",{method:"POST",body:z({mpt:l,schedule:JSON.stringify(f.map(c=>({...c,start:c.start.toString(),end:c.end.toString()})))})});n.ok?_():n.status==409||n.status==400?$({label:"Failed to save schedule",text:await n.text()}):$({label:"Failed to save schedule",text:"An unknown error occurred"})}async function ge(){const n=await fetch("./runmatchmaker/",{method:"POST",body:z({mpt:l,schedule:JSON.stringify(f.map(c=>({...c,start:c.start.toString(),end:c.end.toString()}))),rerun:!0})});n.ok||(n.status==400?$({label:"Failed to run matchmaker",text:await n.text()}):$({label:"Failed to run matchmaker",text:"An unknown error occurred"}))}function ye(){Y({label:r`Clear Matches`,text:r`Are you sure you want to clear all matches? This action cannot be undone.`,buttonText:r`Clear Matches`,onConfirm:async()=>{(await fetch("./clearmatches/",{method:"POST"})).ok&&(F(void 0),Q(!1),B(!1),K(-1))}})}async function xe(){if(M&&!await Y({label:r`Deactivate Schedule`,buttonText:r`Deactivate`,text:'<div className="alert alert-danger" role="alert"><i className="fa fa-exclamation-triangle"></i>'+r`DO NOT deactivate the schedule unless it was activated in error.  The match schedule has already been activated and is public, and you will not be able to play matches with a deactivated schedule.`+'<i className="fa fa-exclamation-triangle"></i></div>'}))return;(await fetch("./active/",{method:"POST",body:M?"false":"true",credentials:"same-origin"})).ok&&B(!M)}async function ve(){if(!R)return;if(O){if(!await Y({label:r`Overwrite Schedule`,text:r`A match schedule already exists for this event. Are you sure you want to import? This will overwrite the current schedule.`}))return;await fetch("./clearmatches/",{method:"POST"}),F(void 0),Q(!1),B(!1),K(-1)}const n=new FormData;n.append("file",R,R.name);const c=await fetch("./import/",{method:"POST",body:n});if(c.ok)window.location.reload();else{const x=await c.text();$({label:"Failed to import schedule",text:x,dangerous:!0})}}const we=L!=u,ae=Object.values(I).some(n=>{const c=n.filter(N);for(let x=1;x<c.length;x++)if(p.PlainDateTime.compare(c[x].start,c[x-1].end)<0)return!0;return!1}),q=we||ae;return e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-center",children:t=="PRACTICE"?r`Practice Match Schedule`:r`Qualfication Match Schedule`}),t=="PRACTICE"?e.jsxs(E,{variant:"warning",className:"text-center",children:[e.jsx("i",{className:"fa fa-exclamation-triangle text-center"})," ",r`WARNING: This is the practice match schedule, not the qualification match schedule!`," ",e.jsx("i",{className:"fa fa-exclamation-triangle text-center"})]}):null,e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-4",children:[e.jsxs("label",{children:[r`Matches per Team:`," "]}),e.jsx(Z,{value:l,onChange:n=>o(n),min:a.minPerTeam,max:a.maxPerTeam})]}),e.jsxs("span",{className:"col-4",children:[r`Teams:`," ",a.teamCount]}),e.jsxs("span",{className:"col-4",children:[r`Total Matches Required:`," ",u]}),j>0?e.jsxs("span",{className:"col-4",children:[r`Last Match Started:`," ",j]}):null]}),a.teamCount<=7?e.jsx(E,{variant:"info",children:r`With ${a.teamCount} teams, there must be a break under T206 between every match. Therefore, the minimum match cycle time is 9 minutes.`}):null,a.teamCount>7&&a.teamCount<=11?e.jsx(E,{variant:"info",children:r`With ${a.teamCount} teams, there must be a break under T206 approximately every other match. Therefore, the average minimum match cycle time is 8 minutes.`}):null,A.map(n=>{var se,re;const c=I[n.toString()]||[],x=((se=c.slice(-1)[0])==null?void 0:se.end)||n.toPlainDateTime(new p.PlainTime(8,0)),H=((re=c.filter(N).slice(-1)[0])==null?void 0:re.cycleTime)||p.Duration.from({minutes:Math.max(W,7)}),G=x.add({seconds:Math.max(0,u-L)*H.total({unit:"second"})});return e.jsxs("div",{children:[e.jsx("h3",{children:n.toLocaleString(document.documentElement.lang,{weekday:"long",month:"long",day:"numeric",year:"numeric"})}),c.map((P,ie)=>{const le=I[n.toString()].slice(0,ie).filter(N).slice(-1)[0],ce=I[n.toString()].slice(ie+1).filter(N)[0];return e.jsx(e.Fragment,{children:N(P)?e.jsx(Ce,{date:n,block:P,updateBlock:J=>w({replace:P,insert:J}),minCycle:W,overlaps:le&&p.PlainDateTime.compare(le.end,P.start)>0||ce&&p.PlainDateTime.compare(P.end,ce.start)>0}):e.jsx(Me,{block:P,updateBlock:J=>w({replace:P,insert:J})})})}),e.jsx(C,{variant:"secondary",size:"sm",className:"mb-2",onClick:()=>w({insert:{type:"MATCH",cycleTime:H,start:x,end:G}}),children:r`Add Match Block`})]},n.toString())}),L!=u?e.jsx(E,{variant:"danger",children:r`${L} matches scheduled, but ${u} matches required`}):null,ae?e.jsx(E,{variant:"danger",children:r`Overlapping matches scheduled`}):null,e.jsxs("div",{children:[e.jsx(C,{variant:"secondary",onClick:fe,disabled:q,children:r`Preview`}),e.jsx(C,{variant:"secondary",onClick:pe,className:"ml-2",disabled:q,children:r`Save`}),O?e.jsx(C,{variant:"warning",disabled:j>0,title:j>0?r`Cannot clear schedule once matches have been played`:"",className:"ml-2",onClick:ye,children:r`Clear Matches`}):e.jsx(C,{variant:"secondary",id:"runMatchmaker",onClick:ge,className:"ml-2",disabled:q||b&&b.status==X.RUNNING,children:r`Run Matchmaker`}),O?e.jsx(C,{id:"activateQualificationSchedule",variant:M?"warning":"primary",className:"ml-2",onClick:xe,disabled:j>0,title:j>0?r`Cannot deactivate schedule once matches have been played`:"",children:t=="QUALS"?M?r`Deactivate Qualification Schedule`:r`Activate Qualification Schedule`:M?r`Deactivate Practice Schedule`:r`Activate Practice Schedule`}):null]}),d?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row justify-content-center mt-2",children:[e.jsx("div",{className:"col-12",children:r`Custom Scheduling:`}),e.jsx("div",{className:"col-2",children:e.jsx("button",{onClick:()=>window.open("export/"),className:"btn btn-secondary",children:"Export Schedule"})}),e.jsx("div",{className:"col-4",children:e.jsx("input",{type:"file",accept:".csv",onChange:n=>{var c;return he(((c=n.target.files)==null?void 0:c[0])||null)}})}),e.jsx("div",{className:"col-2",children:e.jsx("button",{id:"importScheduleButton",onClick:()=>ve(),className:"btn btn-secondary",disabled:!R||j>0,title:j>0?r`Cannot import new schedule once matches have been played`:"",children:"Import Schedule"})}),e.jsx("div",{className:"col-4",children:e.jsx("div",{id:"importStatus",style:{color:"red"}})})]})}):null,b?e.jsx("div",{className:"text-center",children:b.status==X.FAILED?b.data.error:r`MatchMaker running...`}):O?r`Schedule has been generated, see below.`:null,b&&b.status==X.RUNNING?e.jsx(be,{now:b.data.progress,label:`${b.data.progress}%`}):null,V?e.jsx("div",{className:"col-12",children:e.jsx("iframe",{srcDoc:V,width:"100%",height:de,ref:ee,style:{border:"none"},onLoad:()=>me(ee.current.contentWindow.document.body.scrollHeight+"px")})}):null]})}const oe=document.getElementById("reactContainer");oe?Se.createRoot(oe).render(e.jsx(Te,{children:e.jsx($e,{eventCode:window.eventCode,matchCountData:window.matchCountData,initialSchedule:window.currentSchedule.map(a=>{const m={...a,start:p.PlainDateTime.from(a.start),end:p.PlainDateTime.from(a.end)};return m.type=="MATCH"&&(m.cycleTime=p.Duration.from(m.cycleTime)),m}),allowCustomSchedules:window.allowCustomSchedules,startDate:p.PlainDate.from(window.startDate),endDate:p.PlainDate.from(window.endDate),phase:window.matchPhase})})):console.error("Mount point for container not found");
//# sourceMappingURL=matchSchedule-DzknlIir.js.map
