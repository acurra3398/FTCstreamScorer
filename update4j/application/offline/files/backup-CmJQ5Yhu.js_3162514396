import{r as p,j as e,t,c as P}from"../client-BvsFx6Uv.js";import{m as h,p as m}from"../dialogs-Cji8mkGY.js";import"../merge-BCxs0UCa.js";import"../Modal-BSxbHkAp.js";import"../index-CsyH6pUe.js";import"../warning-PI8mi4Hb.js";import"../querySelectorAll-CV_V5nX6.js";import"../createWithBsPrefix-Bt6Ige_C.js";import"../Button-CplEHJLM.js";import"../SafeAnchor-G5C8N4yQ.js";import"../Form-C93KviTp.js";import"../all-crwlzFAZ.js";try{let r=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},c=new r.Error().stack;c&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[c]="69148ef5-00cf-4659-b7f3-b6c08a808c9a",r._sentryDebugIdIdentifier="sentry-dbid-69148ef5-00cf-4659-b7f3-b6c08a808c9a")}catch{}function B({destination:r,remove:c}){const n=new URL(r.uri);let i=r.uri;n.protocol=="file:"?i=t`Directory: ${n.pathname}`:n.protocol.startsWith("http")&&(n.username="",n.password="",i=e.jsxs(e.Fragment,{children:[t`Remote server: `,e.jsx("a",{href:n.href,target:"_blank",rel:"noreferrer",children:n.host})]}));const o=r.lastAttempt?new Date(r.lastAttempt).toLocaleString():"unknown";return e.jsxs("li",{children:[i," ",r.lastError?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fa fa-exclamation-triangle"}),t`(backup failed at ${o})`]}):t`(last backed up at ${o})`,e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>c(r.uri),children:e.jsx("i",{className:"fas fa-trash"})}),r.lastError?e.jsx("details",{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap"},children:r.lastError})}):null]})}function E({data:r}){return e.jsxs("li",{children:[r.event,": (",new Date(r.timestamp).toLocaleString(),") "]})}function C({isReplica:r,replicaPassword:c,backupDestinations:n,importStatuses:i}){const[o,w]=p.useState(r),[g,y]=p.useState(c),[k,u]=p.useState(n);async function j(a){const s=new URLSearchParams;s.append("isReplica",a?"true":"false");const l=await(await fetch("/manage/togglereplica/",{method:"POST",body:s})).json();w(a),a&&y(l.replicaPassword)}async function D(){const a=await m({label:t`Add remote server`,text:t`Remote address`,buttonText:t`Add`});if(!a)return;const s=await m({label:t`Add remote server`,text:t`Backup server password`,buttonText:t`Add`});s&&await f(`http://ems:${s}@${a}`)}async function v(){const a=await m({label:t`Add directory`,text:t`Path to store backups (e.g. D:/ftc-backup or /Volumes/MyDrive/ftc-backup)`,buttonText:t`Add`});if(!a)return;let s="";a.match(/^[a-z]:/i)&&(s="/"),await f(`file://${s}${a}`)}async function f(a){const s=new URLSearchParams;s.append("uri",a),await(await fetch("/manage/backup/",{method:"PUT",body:s})).text()!="OK"?h({label:t`Add failed`,text:t`Failed to add backup destination`}):u(d=>[...d,{uri:a,lastAttempt:Date.now()}])}async function R(a){const s=new URLSearchParams;s.append("uri",a),await(await fetch("/manage/backup/",{method:"DELETE",body:s})).text()!="OK"?h({label:t`Add failed`,text:t`Failed to remove backup destination`}):u(d=>d.filter(A=>A.uri!==a))}return e.jsxs("fieldset",{children:[e.jsx("legend",{children:t`Backup Configuration`}),o?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t`Backup last loaded`}),e.jsx("ul",{children:i==null?void 0:i.sort((a,s)=>a.event.localeCompare(s.event)).map(a=>e.jsx(E,{data:a},a.event))})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t`Backup destinations`}),e.jsx("ul",{children:k.map(a=>e.jsx(B,{destination:a,remove:R},a.uri))}),e.jsx("button",{className:"btn btn-small btn-secondary",onClick:D,children:t`Add remote server`}),e.jsx("button",{className:"btn btn-small btn-secondary ml-2",onClick:v,children:t`Add directory`})]}),e.jsx("p",{children:o?t`Currently acting as replica. Replication password: ${g}`:t`Currently acting as primary.`}),e.jsx("button",{className:`btn btn-${o?"danger":"warning"}`,onClick:()=>j(!o),children:o?t`Become Primary`:t`Become Replica`}),e.jsx("br",{}),e.jsx("small",{children:o?t`This should only be done if the current primary server is now offline`:t`Receive updates from a primary server so this server is ready to take over at a moment's notice`})]})}const x=document.getElementById("backupConfiguration");x?P.createRoot(x).render(e.jsx(C,{isReplica:window.isReplica||!1,replicaPassword:window.replicaPassword||"",backupDestinations:window.backupDestinations,importStatuses:window.importStatuses})):console.error("Mount point for ref container not found");
//# sourceMappingURL=backup-CmJQ5Yhu.js.map
